<!DOCTYPE html>
<html>
<head>
    <title>MS-15 End-to-End Workflow Testing</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <h1>MS-15 End-to-End Workflow Tests</h1>
    <div id="results"></div>
    
    <!-- Complete DOM structure for full app testing -->
    <div style="display: none;">
        <div id="app">
            <div id="loginScreen" class="screen active">
                <div class="login-container">
                    <input type="text" id="username" placeholder="Name">
                    <input type="password" id="password" placeholder="Passwort">
                    <button id="loginBtn" type="button">Anmelden</button>
                    <div id="loginError" class="error-message"></div>
                </div>
            </div>
            
            <div id="mainApp" class="screen">
                <header id="appHeader">
                    <div class="user-info">
                        <span id="userName"></span>
                        <span id="userClass"></span>
                    </div>
                </header>
                
                <nav id="mainNav">
                    <button class="nav-btn active" data-section="start">Start</button>
                    <button class="nav-btn" data-section="workbook">Arbeitsbuch</button>
                    <button class="nav-btn" data-section="exam">Prüfung</button>
                    <button class="nav-btn" data-section="progress">Fortschritt</button>
                </nav>
                
                <main id="content">
                    <section id="startSection" class="content-section active">
                        <div class="user-name-display"></div>
                        <div class="user-class-display"></div>
                        <div id="loginTime"></div>
                        <div id="completedTopics">0</div>
                        <div id="progressPercent">0%</div>
                    </section>
                    
                    <section id="workbookSection" class="content-section">
                        <div class="workbook-layout">
                            <aside class="workbook-sidebar" id="workbookMenu">
                                <ul id="topicList"></ul>
                            </aside>
                            <div class="workbook-content" id="workbookContent">
                                <p>Wähle ein Thema aus dem Menü links.</p>
                            </div>
                        </div>
                    </section>
                    
                    <section id="examSection" class="content-section">
                        <div id="examContent"></div>
                        <div id="questionArea" class="question-area">
                            <div class="question-header">
                                <span id="questionCounter"></span>
                                <span id="questionTopic" class="question-topic"></span>
                            </div>
                            <div id="questionText" class="question-text"></div>
                            <textarea id="examAnswer" class="exam-input"></textarea>
                            <div id="feedback" class="feedback"></div>
                        </div>
                    </section>
                    
                    <section id="progressSection" class="content-section">
                        <div id="progressContent">
                            <div class="progress-bar-container">
                                <div class="progress-bar">
                                    <div class="progress-fill" id="progressFill"></div>
                                </div>
                                <span class="progress-text" id="progressText">0%</span>
                            </div>
                            <div id="progressDetails"></div>
                            <div id="statsContent"></div>
                        </div>
                    </section>
                </main>
            </div>
        </div>
    </div>

    <script src="js/storage.js"></script>
    <script src="js/auth.js"></script>
    <script src="js/workbook.js"></script>
    <script src="js/drawing.js"></script>
    <script src="js/claude-api.js"></script>
    <script src="js/exam.js"></script>
    <script src="js/progress.js"></script>
    <script>
        // MS-15: End-to-End workflow comprehensive testing
        const results = document.getElementById('results');
        
        function log(message) {
            results.innerHTML += message + '<br>';
            console.log(message);
        }
        
        function runTest(name, testFn) {
            try {
                const result = testFn();
                log(`✅ ${name}: PASS`);
                return true;
            } catch (error) {
                log(`❌ ${name}: FAIL - ${error.message}`);
                return false;
            }
        }
        
        async function runAsyncTest(name, testFn) {
            try {
                const result = await testFn();
                log(`✅ ${name}: PASS`);
                return true;
            } catch (error) {
                log(`❌ ${name}: FAIL - ${error.message}`);
                return false;
            }
        }
        
        log('MS-15 End-to-End Workflow Tests (Login→Arbeitsbuch→Prüfung→Fortschritt):');
        let testsPassed = 0;
        let testsTotal = 0;
        
        function test(name, fn) {
            testsTotal++;
            if (runTest(name, fn)) testsPassed++;
        }
        
        async function asyncTest(name, fn) {
            testsTotal++;
            if (await runAsyncTest(name, fn)) testsPassed++;
        }
        
        // Helper function to simulate user interactions
        function simulateClick(selector) {
            const element = document.querySelector(selector);
            if (!element) throw new Error(`Element ${selector} not found for click`);
            element.click();
        }
        
        function simulateInput(selector, value) {
            const element = document.querySelector(selector);
            if (!element) throw new Error(`Element ${selector} not found for input`);
            element.value = value;
            element.dispatchEvent(new Event('input', { bubbles: true }));
        }
        
        // Mock App object for navigation
        window.App = {
            navigateTo(section) {
                // Hide all sections
                document.querySelectorAll('.content-section').forEach(section => {
                    section.classList.remove('active');
                });
                // Show target section
                const targetSection = document.getElementById(section + 'Section');
                if (targetSection) {
                    targetSection.classList.add('active');
                }
                
                // Update nav buttons
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                const targetBtn = document.querySelector(`[data-section="${section}"]`);
                if (targetBtn) {
                    targetBtn.classList.add('active');
                }
            },
            
            showSection(section) {
                this.navigateTo(section);
            },
            
            updateHomepageStats() {
                // Mock homepage stats update
                const allWorkbookData = Storage.getAllWorkbookData();
                let completedCount = Object.keys(allWorkbookData).length;
                
                const completedTopics = document.getElementById('completedTopics');
                const progressPercent = document.getElementById('progressPercent');
                
                if (completedTopics) {
                    completedTopics.textContent = completedCount;
                }
                
                if (progressPercent) {
                    let totalPages = 0;
                    Workbook.topics.forEach(topic => totalPages += topic.pages.length);
                    const percent = totalPages > 0 ? Math.round((completedCount / totalPages) * 100) : 0;
                    progressPercent.textContent = percent + '%';
                }
            }
        };
        
        // Clear localStorage for clean testing
        localStorage.clear();
        
        // Test 1: Complete Login Workflow
        log('<h2>1. Login Workflow:</h2>');
        
        test('Initial app state', () => {
            // Should show login screen initially
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (!loginScreen.classList.contains('active')) {
                throw new Error('Login screen should be active initially');
            }
            
            if (mainApp.classList.contains('active')) {
                throw new Error('Main app should not be active initially');
            }
            
            return true;
        });
        
        test('Invalid login handling', () => {
            simulateInput('#username', 'Invalid User');
            simulateInput('#password', 'wrong-password');
            
            const result = Auth.login(
                document.getElementById('username').value,
                document.getElementById('password').value
            );
            
            if (result.success !== false) {
                throw new Error('Invalid login should fail');
            }
            
            if (!result.error.includes('Falscher Benutzername')) {
                throw new Error('Error message not displayed correctly');
            }
            
            return true;
        });
        
        test('Successful login workflow', () => {
            simulateInput('#username', 'Kaspar Haessig');
            simulateInput('#password', '001b26c');
            
            const result = Auth.login(
                document.getElementById('username').value,
                document.getElementById('password').value
            );
            
            if (!result.success) {
                throw new Error('Valid login should succeed: ' + result.error);
            }
            
            if (!result.user || result.user.name !== 'Kaspar Haessig') {
                throw new Error('User data not returned correctly');
            }
            
            // Update UI elements that would normally be updated by app.js
            document.getElementById('userName').textContent = result.user.name;
            document.getElementById('userClass').textContent = result.user.class;
            document.querySelector('.user-name-display').textContent = result.user.name;
            document.querySelector('.user-class-display').textContent = result.user.class;
            
            // Switch to main app view
            document.getElementById('loginScreen').classList.remove('active');
            document.getElementById('mainApp').classList.add('active');
            
            return true;
        });
        
        test('Auto-login functionality', () => {
            // Clear current session
            Auth.currentUser = null;
            
            // Should auto-login from stored data
            const autoLogin = Auth.checkAutoLogin();
            if (!autoLogin) {
                throw new Error('Auto-login should succeed with stored data');
            }
            
            if (!Auth.currentUser || Auth.currentUser.name !== 'Kaspar Haessig') {
                throw new Error('Auto-login did not restore user correctly');
            }
            
            return true;
        });
        
        // Test 2: Workbook Workflow
        log('<h2>2. Workbook Usage Workflow:</h2>');
        
        test('Workbook initialization and menu', () => {
            App.navigateTo('workbook');
            Workbook.initMenu();
            
            const topicList = document.getElementById('topicList');
            if (topicList.children.length === 0) {
                throw new Error('Workbook menu not initialized');
            }
            
            // Should have category headers and topic items
            const categoryHeaders = topicList.querySelectorAll('.category-header');
            const topicItems = topicList.querySelectorAll('.topic-item');
            
            if (categoryHeaders.length === 0) {
                throw new Error('Category headers not created');
            }
            
            if (topicItems.length === 0) {
                throw new Error('Topic items not created');
            }
            
            return true;
        });
        
        test('Topic selection and page loading', () => {
            // Select first topic
            const firstTopic = Workbook.topics[0];
            Workbook.loadTopic(firstTopic.id);
            
            if (Workbook.currentTopic !== firstTopic) {
                throw new Error('Topic not selected correctly');
            }
            
            const content = document.getElementById('workbookContent');
            if (!content.innerHTML.includes(firstTopic.title)) {
                throw new Error('Topic content not displayed');
            }
            
            return true;
        });
        
        test('Page loading with inputs and canvas', () => {
            // Load a specific page with inputs
            Workbook.loadPage('werkstatt-1'); // Has both inputs and drawing areas
            
            if (!Workbook.currentPage || Workbook.currentPage.id !== 'werkstatt-1') {
                throw new Error('Page not loaded correctly');
            }
            
            const content = document.getElementById('workbookContent');
            
            // Should have inputs
            const inputs = content.querySelectorAll('.workbook-input');
            if (inputs.length === 0) {
                throw new Error('Workbook inputs not rendered');
            }
            
            // Should have drawing areas (if applicable)
            const drawingAreas = content.querySelectorAll('.drawing-areas');
            if (drawingAreas.length === 0) {
                throw new Error('Drawing areas not rendered for werkstatt-1');
            }
            
            return true;
        });
        
        test('Data entry and saving', () => {
            // Fill in some test data
            const inputs = document.querySelectorAll('.workbook-input');
            if (inputs.length > 0) {
                inputs[0].value = 'Test Name Entry';
                if (inputs.length > 1) {
                    inputs[1].value = 'B26c';
                }
            }
            
            // Save the page
            Workbook.savePage();
            
            // Verify data was saved
            const savedData = Storage.getWorkbookData('werkstatt-1');
            if (!savedData) {
                throw new Error('Page data not saved');
            }
            
            if (!savedData.inputs || !savedData.inputs.input_0) {
                throw new Error('Input data not saved correctly');
            }
            
            if (savedData.inputs.input_0 !== 'Test Name Entry') {
                throw new Error('Input value not saved correctly');
            }
            
            return true;
        });
        
        test('Data persistence and loading', () => {
            // Load another page and come back
            Workbook.loadPage('sicherheit-1');
            Workbook.loadPage('werkstatt-1');
            
            // Data should be restored
            const inputs = document.querySelectorAll('.workbook-input');
            if (inputs.length > 0 && inputs[0].value !== 'Test Name Entry') {
                throw new Error('Data not restored after page navigation');
            }
            
            return true;
        });
        
        // Test 3: Exam Workflow
        log('<h2>3. Exam Workflow:</h2>');
        
        test('Exam initialization with workbook data', () => {
            App.navigateTo('exam');
            
            // Initialize exam system
            Exam.init();
            Exam.showExamContent();
            
            const examContent = document.getElementById('examContent');
            if (!examContent.innerHTML) {
                throw new Error('Exam content not rendered');
            }
            
            // Should have questions available based on workbook data
            if (Exam.availableQuestions.length === 0) {
                throw new Error('No questions generated from workbook data');
            }
            
            return true;
        });
        
        test('Question generation and display', () => {
            // Start random exam
            Exam.startRandomExam();
            
            if (!Exam.currentQuestion) {
                throw new Error('Random exam did not start properly');
            }
            
            const questionArea = document.getElementById('questionArea');
            if (questionArea.style.display === 'none') {
                throw new Error('Question area not displayed');
            }
            
            const questionText = document.getElementById('questionText');
            if (!questionText.textContent) {
                throw new Error('Question text not displayed');
            }
            
            return true;
        });
        
        asyncTest('Answer checking workflow', async () => {
            // Enter an answer
            const answerInput = document.getElementById('examAnswer');
            answerInput.value = 'Test answer for evaluation';
            
            // Check answer (this is async)
            await Exam.checkAnswer();
            
            const feedback = document.getElementById('feedback');
            if (!feedback.innerHTML) {
                throw new Error('Feedback not displayed after answer check');
            }
            
            // Should show either correct or incorrect feedback
            const hasCorrectFeedback = feedback.innerHTML.includes('✅') || feedback.innerHTML.includes('❌');
            if (!hasCorrectFeedback) {
                throw new Error('Answer evaluation feedback not displayed');
            }
            
            return true;
        });
        
        test('Question navigation', () => {
            const originalQuestion = Exam.currentQuestion;
            
            Exam.nextQuestion();
            
            if (!Exam.currentQuestion) {
                throw new Error('Next question not loaded');
            }
            
            // Question should be displayed
            const questionText = document.getElementById('questionText');
            if (!questionText.textContent) {
                throw new Error('Next question text not displayed');
            }
            
            return true;
        });
        
        test('Learning progress tracking', () => {
            const testQuestionId = 'test_workflow_question';
            
            // Simulate multiple attempts
            Exam.updateLearningProgress(testQuestionId, false); // Wrong
            Exam.updateLearningProgress(testQuestionId, true);  // Right
            Exam.updateLearningProgress(testQuestionId, true);  // Right
            Exam.updateLearningProgress(testQuestionId, true);  // Right - should be mastered
            
            const examData = Storage.getExamData();
            const questionData = examData.learned[testQuestionId];
            
            if (!questionData.mastered) {
                throw new Error('Question not marked as mastered after 3 correct');
            }
            
            if (questionData.correctStreak !== 3) {
                throw new Error('Correct streak not tracked properly');
            }
            
            return true;
        });
        
        // Test 4: Progress Tracking Workflow
        log('<h2>4. Progress Tracking Workflow:</h2>');
        
        test('Progress calculation after workbook completion', () => {
            App.navigateTo('progress');
            
            Progress.init();
            Progress.updateDisplay();
            
            const progressText = document.getElementById('progressText');
            if (!progressText.textContent.includes('von')) {
                throw new Error('Progress text not updated');
            }
            
            const progressFill = document.getElementById('progressFill');
            if (!progressFill.style.width || progressFill.style.width === '0%') {
                throw new Error('Progress bar not updated');
            }
            
            return true;
        });
        
        test('Detailed progress per topic', () => {
            Progress.showDetailedProgress();
            
            const progressDetails = document.getElementById('progressDetails');
            if (!progressDetails.innerHTML.includes('topic-progress')) {
                throw new Error('Detailed progress not displayed');
            }
            
            // Should show progress for topics
            if (!progressDetails.innerHTML.includes('WERKSTATTREGELN')) {
                throw new Error('Topic progress not shown');
            }
            
            return true;
        });
        
        test('Advanced statistics display', () => {
            Progress.showStats();
            
            const statsContent = document.getElementById('statsContent');
            if (!statsContent.innerHTML.includes('Gesamtfortschritt')) {
                throw new Error('Advanced statistics not displayed');
            }
            
            if (!statsContent.innerHTML.includes('stat-card')) {
                throw new Error('Statistics cards not rendered');
            }
            
            return true;
        });
        
        test('Homepage stats integration', () => {
            App.navigateTo('start');
            App.updateHomepageStats();
            
            const completedTopics = document.getElementById('completedTopics');
            const progressPercent = document.getElementById('progressPercent');
            
            if (completedTopics.textContent === '0') {
                throw new Error('Homepage completed topics not updated');
            }
            
            if (progressPercent.textContent === '0%') {
                throw new Error('Homepage progress percent not updated');
            }
            
            return true;
        });
        
        // Test 5: Navigation and State Management
        log('<h2>5. Navigation & State Management:</h2>');
        
        test('Section navigation workflow', () => {
            // Test navigation between all sections
            const sections = ['start', 'workbook', 'exam', 'progress'];
            
            for (const section of sections) {
                App.navigateTo(section);
                
                const sectionElement = document.getElementById(section + 'Section');
                if (!sectionElement.classList.contains('active')) {
                    throw new Error(`Section ${section} not activated properly`);
                }
                
                const navBtn = document.querySelector(`[data-section="${section}"]`);
                if (!navBtn.classList.contains('active')) {
                    throw new Error(`Navigation button for ${section} not activated`);
                }
            }
            
            return true;
        });
        
        test('State persistence across navigation', () => {
            // Go to workbook, set some state, navigate away and back
            App.navigateTo('workbook');
            Workbook.loadTopic('werkstattregeln');
            const originalTopic = Workbook.currentTopic;
            
            // Navigate away
            App.navigateTo('exam');
            App.navigateTo('progress');
            
            // Navigate back
            App.navigateTo('workbook');
            
            // State should be preserved
            if (Workbook.currentTopic !== originalTopic) {
                throw new Error('Workbook state not preserved across navigation');
            }
            
            return true;
        });
        
        test('User session persistence', () => {
            const originalUser = Auth.getUser();
            
            // Simulate page reload (clear in-memory state)
            Auth.currentUser = null;
            
            // Should restore from storage
            Auth.checkAutoLogin();
            
            const restoredUser = Auth.getUser();
            if (!restoredUser || restoredUser.name !== originalUser.name) {
                throw new Error('User session not restored properly');
            }
            
            return true;
        });
        
        // Test 6: Data Consistency Workflow
        log('<h2>6. Data Consistency & Integration:</h2>');
        
        test('Workbook → Exam data flow', () => {
            // Ensure workbook data creates exam questions
            const workbookData = Storage.getAllWorkbookData();
            const workbookPageCount = Object.keys(workbookData).length;
            
            if (workbookPageCount === 0) {
                throw new Error('No workbook data for exam integration test');
            }
            
            Exam.buildQuestionPool();
            
            if (Exam.availableQuestions.length === 0) {
                throw new Error('Workbook data not converted to exam questions');
            }
            
            return true;
        });
        
        test('Exam → Progress data flow', () => {
            // Ensure exam performance affects progress statistics
            const testQuestionId = 'integration_test_question';
            
            const originalStats = Progress.calculateAdvancedStats();
            
            // Simulate exam performance
            Exam.updateLearningProgress(testQuestionId, false);
            Exam.updateLearningProgress(testQuestionId, true);
            
            const newStats = Progress.calculateAdvancedStats();
            
            if (newStats.totalAttempts <= originalStats.totalAttempts) {
                throw new Error('Exam performance not reflected in progress stats');
            }
            
            return true;
        });
        
        test('Cross-module data consistency', () => {
            // Test that data changes in one module are reflected in others
            
            // Add new workbook data
            Storage.saveWorkbookData('test-consistency-page', {
                timestamp: new Date().toISOString(),
                inputs: { input_0: 'Consistency test answer' },
                canvases: {}
            });
            
            // Should affect progress calculations
            const oldStats = Progress.calculateAdvancedStats();
            const newStats = Progress.calculateAdvancedStats();
            
            // Should affect exam questions
            Exam.buildQuestionPool();
            const hasConsistencyQuestion = Exam.availableQuestions.some(
                q => q.pageId === 'test-consistency-page'
            );
            
            if (!hasConsistencyQuestion) {
                throw new Error('New workbook data not reflected in exam questions');
            }
            
            return true;
        });
        
        // Test 7: Error Recovery Workflow
        log('<h2>7. Error Recovery & Robustness:</h2>');
        
        test('Storage corruption recovery', () => {
            // Simulate corrupted data
            localStorage.setItem('werkbuch_user', 'invalid-json');
            
            // App should recover gracefully
            const user = Auth.checkAutoLogin();
            if (user !== false) {
                throw new Error('Should fail gracefully with corrupted user data');
            }
            
            // Should clear corrupted data
            const clearedData = localStorage.getItem('werkbuch_user');
            if (clearedData === 'invalid-json') {
                throw new Error('Corrupted data not cleared');
            }
            
            return true;
        });
        
        test('Network failure simulation', () => {
            // Test exam functionality without API
            ClaudeAPI.isAvailable = false;
            
            // Should fall back to local evaluation
            const evaluation = ClaudeAPI.fallbackEvaluation('test answer', 'test answer');
            
            if (!evaluation.isCorrect) {
                throw new Error('Local fallback not working');
            }
            
            if (evaluation.method !== 'local-fallback') {
                throw new Error('Fallback method not identified correctly');
            }
            
            return true;
        });
        
        test('Invalid navigation handling', () => {
            // Should handle invalid section gracefully
            try {
                App.navigateTo('nonexistent-section');
                // Should not throw error
            } catch (error) {
                throw new Error('Invalid navigation threw error: ' + error.message);
            }
            
            return true;
        });
        
        // Test 8: Logout Workflow
        log('<h2>8. Logout & Cleanup Workflow:</h2>');
        
        test('Complete logout workflow', () => {
            // Logout should clear all data
            Auth.logout();
            
            if (Auth.currentUser !== null) {
                throw new Error('Current user not cleared');
            }
            
            // Storage should be cleared
            const userData = Storage.getUser();
            if (userData !== null) {
                throw new Error('Stored user data not cleared');
            }
            
            return true;
        });
        
        test('Post-logout state', () => {
            // After logout, should be back to initial state
            if (Auth.checkAutoLogin()) {
                throw new Error('Should not auto-login after logout');
            }
            
            // UI should reset (would normally be done by app.js)
            document.getElementById('loginScreen').classList.add('active');
            document.getElementById('mainApp').classList.remove('active');
            
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            
            if (!loginScreen.classList.contains('active')) {
                throw new Error('Login screen not shown after logout');
            }
            
            if (mainApp.classList.contains('active')) {
                throw new Error('Main app still active after logout');
            }
            
            return true;
        });
        
        // Final Results
        setTimeout(() => {
            log(`<h2>🎯 Test Results: ${testsPassed}/${testsTotal} tests passed</h2>`);
            
            if (testsPassed === testsTotal) {
                log('<h2 style="color: green">✅ ALL END-TO-END WORKFLOW TESTS PASSED!</h2>');
                log('<p>🔐 <strong>Login Workflow</strong>: Authentication, auto-login, session management ✓</p>');
                log('<p>📚 <strong>Workbook Workflow</strong>: Menu navigation, page loading, data entry, persistence ✓</p>');
                log('<p>🎓 <strong>Exam Workflow</strong>: Question generation, answer checking, progress tracking ✓</p>');
                log('<p>📊 <strong>Progress Workflow</strong>: Statistics calculation, detailed tracking, homepage integration ✓</p>');
                log('<p>🧭 <strong>Navigation & State</strong>: Section switching, state persistence across navigation ✓</p>');
                log('<p>🔄 <strong>Data Consistency</strong>: Cross-module integration, real-time updates ✓</p>');
                log('<p>🛡️ <strong>Error Recovery</strong>: Graceful failure handling, data corruption recovery ✓</p>');
                log('<p>🚪 <strong>Logout Workflow</strong>: Complete cleanup, state reset ✓</p>');
                log('<br><h3 style="color: green">🎉 The app is ready for production use!</h3>');
                log('<p>All critical user workflows tested and working correctly.</p>');
            } else {
                log(`<h2 style="color: red">❌ ${testsTotal - testsPassed} CRITICAL WORKFLOW TESTS FAILED</h2>`);
                log('<p style="color: red">⚠️ The application has issues that must be resolved before production use!</p>');
            }
            
            // Clean up
            localStorage.clear();
            Auth.currentUser = null;
            Workbook.currentTopic = null;
            Workbook.currentPage = null;
            Exam.currentQuestion = null;
            Progress.progressData = null;
        }, 100);
    </script>
</body>
</html>